---
title: "Summary simulation results"
author: ""
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    
---

```{r setup, include=FALSE}
library(ggplot2)
library(gridExtra)
library(ggpubr)

load("C:/Users/Marta/Dropbox/C5/Scripts/GitKraken/CBE_selection/results/results_H0_True.RData")
knitr::opts_chunk$set(echo = TRUE) 

```

## Summary

Main modifications with respect to previous versions:

  - The scenarios considered for the simulation study are a subset of the previous version. *CHECK*


## Design and main assumptions

We simulate a two-arm trial with two binary endpoints according to the following parameters:

  - Probability endpoint 1 control group ($p_1^{(0)}$): $0.1, 0.2$;
  - Probability endpoint 2 control group ($p_2^{(0)}$): $0.1, 0.25$;
  - Odds ratio endpoint 1 ($OR_1$): $0.6, 0.7, 0.8$;
  - Odds ratio endpoint 2 ($OR_2$): $0.75, 0.8$;
  - Correlation between endpoints ($\rho$): $0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8$.  

The correlation between the endpoints is assumed to be equal for both groups. We note that since the correlation is bounded between two values defined by ($p_1^{(0)},p_2^{(0)},OR_1,OR_2$), not all the combinations of  ($p_1^{(0)},p_2^{(0)},OR_1,OR_2,\rho$)  are possible. We calculate the correlation bounds for each combination of ($p_1^{(0)},p_2^{(0)},OR_1,OR_2$) and discard those scenarios in which the correlation is not within the valid range. The total number of scenarios is $187$.

We consider the composite binary endpoint formed by endpoints 1 and 2. 
Based on the parameters ($p_1^{(0)},p_2^{(0)},OR_1,OR_2,\rho$), we compute:

  - Probability composite endpoint control group ($p_*^{(0)}$);
  - Odds ratio composite endpoint ($OR_*$);
  
  
We assume that the endpoint 1 is more relevant for the clinical question than endpoint 2.
We consider the Asymptotic Relative Efficiency (ARE) method to quantify the efficiency of using the composite endpoint over the endpoint 1 as primary endpoint of the trial. Based on the parameters ($p_1^{(0)},p_2^{(0)},OR_1,OR_2,\rho$), we compute:

  - ARE value;
  - ARE Decision: *CE*, if the composite endpoint is preferred; *RE*, if the endpoint 1 is preferred.


We calculate the sample size to have $0.70$ power to detect an effect of $OR_1$ on the endpoint 1 at significance level $\alpha = 0.05$. 

## Cases under study

We evaluate through simulations the statistical power and significance level under different situations and using different primary endpoints.

For each scenario, we compare the two groups based on three endpoints:

  - the relevant endpoint: we consider endpoint 1 as the primary endpoint;
  - the composite endpoint: we consider the composite endpoint formed by the union of endpoint 1 and endpoint 2 as the primary endpoint;
  - the selected endpoint: we select the primary endpoint at the end of the trial. We do so based on the ARE method and using blinded data to estimate the probabilities under the control group and the correlation. 
  
Remarks: 
1) we simulate $100000$ trials for each scenario and for each endpoint considered as primary endpoint; 
2) we estimate the correlation using the estimated probabilities ($p_1^{(0)},p_2^{(0)},p_*^{(0)}$). 

For each scenario, we evaluate the following situations:

  1. Under alternative hypothesis ($H_1$):
  
      a. testing the group differences based on the endpoint 1.
      b. testing the group differences based on the composite endpoint. 
      c. testing the group differences based on the selected endpoint.
  
  2. Under the null hypothesis ($H_0$): 
  
      a. testing the group differences based on the endpoint 1.
      b. testing the group differences based on the composite endpoint. 
      c. testing the group differences based on the selected endpoint.

When simulating under $H_0$, we consider $OR_1=OR_2=1$; whereas when simulating under $H_1$; we consider the previous mentioned values for $OR_1$, $OR_2$, and $OR_*$.

## Results

### Situations (1a) and (1b)

In what follows we compare the statistical powers obtained using the composite endpoint with the ones obtained using the endpoint 1 as  primary endpoint. We also evaluate the concordance between the choice of the primary endpoint
<!-- decision between using the composite endpoint or the endpoint 1  -->
-according to the ARE value- and the difference in powers obtained in the simulation.  In this case, we calculate the ARE at the beginning of the study, and then according to the parameters ($p_1^{(0)},p_2^{(0)},OR_1,OR_2,\rho$).

```{r} 
dataset$diff_powers = dataset$Test_Power_CE - dataset$Test_Power_RE 
```

The following plot shows the relationship between the ARE value and the difference in power between using the composite endpoint or using the endpoint 1. 
```{r}
ggplot(dataset, aes(x=ARE, y=diff_powers, color=as.factor(decision))) + geom_point(size=2) + labs(y = "Difference in power (Power CE - Power RE)", x="ARE", color="Decision")
```

Cases in which there is no concordance between the decision and the power gain: 
```{r}
dataset$gain_power = ifelse(dataset$diff_powers>0, "CE", "RE")
dataset$gain_power = as.factor(dataset$gain_power)
dataset$decision = as.factor(dataset$decision)

summary(subset(dataset,dataset$gain_power != dataset$decision)[,c(3,4,18,19,20,21,22)])
```

### Case (1c) 

The following figure illustrates the empirical power we obtained using the composite endpoint (CE), the endpoint 1 (RE) or the selected endpoint (SE). 
```{r, warning=F}
power_data <- data.frame(Power=c(dataset$Test_Power_ES,dataset$Test_Power_CE,dataset$Test_Power_RE),
           Endpoint=c(rep("SE",length(dataset$Test_Power_ES)),rep("CE",length(dataset$Test_Power_CE)),rep("RE",length(dataset$Test_Power_RE)))
           )

ggplot(power_data, aes(x=Endpoint, y=Power)) + geom_boxplot() 
```

We compare the maximum between the power using the composite endpoint and the maximum using the relevant endpoint with the power obtained using the selected endpoint.

```{r warning=FALSE}

dataset$diff_es = ifelse(dataset$gain_power=="CE", dataset$Test_Power_ES-dataset$Test_Power_CE,dataset$Test_Power_ES-dataset$Test_Power_RE)
summary(dataset$diff_es)
```



### Cases (2a), (2b), and (2c) 


The following boxplots show the significance level obtained using the composite endpoint (CE), the endpoint 1 (RE) or the selected endpoint (SE). 
```{r, warning=F}
signlevel_data <- data.frame(signlevel=c(dataset$Test_Reject_ES,dataset$Test_Reject_CE,dataset$Test_Reject_RE),
           Endpoint=c(rep("SE",length(dataset$Test_Power_ES)),rep("CE",length(dataset$Test_Power_CE)),rep("RE",length(dataset$Test_Power_RE)))
           )

ggplot(signlevel_data, aes(x=Endpoint, y=signlevel)) + geom_boxplot()
```



## Conclusions and future directions

Conclusions:

  - The powers using the selected endpoint are larger than the ones obtained using the composite endpoint and the relevant endpoint.
  - The significance level is similar in the three situations.

Open questions:

  - Which are the input parameters anticipated for the design of the trial? ($p_1^{(0)},p_2^{(0)},OR_1,OR_2,\rho$) or ($p_1^{(0)},p_2^{(0)},p_*^{(0)},OR_1,OR_2$)?
  - Review assumptions correlation bounds

Future steps: 

  - Improve R code
  - Next step: to consider an interim stage to estimate the probabilities under the control group and the correlation.


## Additional figures

For each scenario, we plot how the difference in power behaves according to the correlation.
<!-- # ```{r} -->
<!-- # p <- list() -->
<!-- # it <- 1 -->
<!-- # for(i in 1:max(dataset$scenario)){ -->
<!-- #   sub=subset(dataset,dataset$scenario==i) -->
<!-- #   p[[i]] <-ggplot(sub, aes(x=corr, y=diff_powers, color=as.factor(decision)))+ ggtitle(paste("Scenario", dataset$scenario[it], "\n (p1,p2,OR1,OR2)=(", dataset$p0_e1[it],",",dataset$p0_e2[it],",",dataset$OR1[it],",",dataset$OR2[it],")"))+ geom_point(size=2) + labs(y = "Power difference", x="Correlation", color="Decision") + coord_cartesian(ylim = c(-0.25, 0.75))+ theme(plot.title = element_text(size=9))+ geom_path() -->
<!-- #   it <- it + dim(subset(dataset,dataset$scenario==i)) -->
<!-- # } -->
<!-- # marrangeGrob(p,ncol=2,nrow=2,top=NULL,layout_matrix = matrix(1:4, 2, 2, TRUE)) -->
<!-- # ``` -->

```{r, fig.height=4, fig.width=10} 
p <- list() 
enum = 1 
it <- 1
for(i in 1:max(dataset$scenario)){
  sub=subset(dataset,dataset$scenario==i)
  p[[enum]] <-ggplot(sub, aes(x=corr, y=Test_Power_ES, color=as.factor(decision)))  +
    geom_point(size=2)+ ggtitle(paste("Scenario", dataset$scenario[it], "\n (p1,p2,OR1,OR2) \n=(", dataset$p0_e1[it],",",dataset$p0_e2[it],",",dataset$OR1[it],",",dataset$OR2[it],")"))+geom_point(size=2)  + labs(y = "Empirical Power (ES)", x="Correlation", color="Decision") + coord_cartesian(ylim = c(0.60, 1))+ geom_path()+ theme(plot.title = element_text(size=9),legend.position = c(0.8, 0.2))
  # ,legend.position="bottom"
  p[[enum+1]] <-ggplot(sub, aes(x=corr, y=Test_Power_CE))  +
    geom_point(size=2)+ ggtitle(paste("Scenario", dataset$scenario[it], "\n (p1,p2,OR1,OR2) \n=(", dataset$p0_e1[it],",",dataset$p0_e2[it],",",dataset$OR1[it],",",dataset$OR2[it],")"))+geom_point(size=2)  + labs(y = "Empirical Power (CE)", x="Correlation", color="Decision") + coord_cartesian(ylim = c(0.60, 1))+ geom_path()+ theme(plot.title = element_text(size=9))
  p[[enum+2]] <-ggplot(sub, aes(x=corr, y=Test_Power_RE))  +
    geom_point(size=2)+ ggtitle(paste("Scenario", dataset$scenario[it], "\n (p1,p2,OR1,OR2) \n=(", dataset$p0_e1[it],",",dataset$p0_e2[it],",",dataset$OR1[it],",",dataset$OR2[it],")"))+geom_point(size=2)  + labs(y = "Empirical Power (RE)", x="Correlation", color="Decision") + coord_cartesian(ylim = c(0.60, 1))+ geom_path()+ theme(plot.title = element_text(size=9))

  
stable <- data.frame(Corr=sub$corr,ARE=round(sub$ARE,2),Decision=round(100*sub$decision_ES,2)) 
  p[[enum+3]] <- ggtexttable(stable, rows = NULL, theme = ttheme(base_style = "default", base_size = 9))
  
  enum=enum+4 
  it <- it + dim(subset(dataset,dataset$scenario==i))
}
marrangeGrob(p,ncol=4,nrow=1,top=NULL) 
# ,heights = c(5, 10)
```

<!-- ```{r} -->
<!-- p <- list() -->
<!-- it <- 1 -->
<!-- for(i in 1:max(dataset$scenario)){ -->
<!--   sub=subset(dataset,dataset$scenario==i) -->
<!--   p[[i]] <-ggplot(sub, aes(x=corr, y=ARE, color=as.factor(decision))) + ggtitle(paste("Scenario", dataset$scenario[it], "\n (p1,p2,OR1,OR2)=(", dataset$p0_e1[it],",",dataset$p0_e2[it],",",dataset$OR1[it],",",dataset$OR2[it],")"))+geom_point(size=2) + labs(y = "ARE", x="Correlation", color="Decision") + coord_cartesian(ylim = c(-0, 5)) + theme(plot.title = element_text(size=9)) -->
<!--   it <- it + dim(subset(dataset,dataset$scenario==i)) -->
<!-- } -->
<!-- marrangeGrob(p,ncol=2,nrow=2,top=NULL,layout_matrix = matrix(1:4, 2, 2, TRUE)) -->
<!-- ``` -->




